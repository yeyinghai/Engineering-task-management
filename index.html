<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob:; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <title>æ™ºèƒ½åŒ–æ–½å·¥ä»»åŠ¡ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="styles/main.css">
    <script src="config.js"></script>
    <script>
        // æƒé™æ£€æŸ¥ï¼šç¡®ä¿ç”¨æˆ·å·²ç™»å½•
        (function checkAuth() {
            // æ ‡è®°ï¼šé˜²æ­¢é‡å¤æ£€æŸ¥
            if (window.__authChecked) return;
            window.__authChecked = true;

            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            fetch('api/index.php/auth?action=check', {
                method: 'GET',
                credentials: 'include'
            })
            .then(res => res.json())
            .then(data => {
                if (!data.success) {
                    // æœªç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢
                    window.location.href = 'login.html';
                } else {
                    // å·²ç™»å½•ï¼Œæ˜¾ç¤ºç”¨æˆ·åï¼ˆå¯é€‰ï¼‰
                    console.log('ç”¨æˆ·å·²ç™»å½•:', data.data.username);
                }
            })
            .catch(error => {
                console.error('æƒé™æ£€æŸ¥å¤±è´¥:', error);
                // é”™è¯¯æ—¶ä¹Ÿé‡å®šå‘åˆ°ç™»å½•é¡µé¢
                window.location.href = 'login.html';
            });
        })();
    </script>
</head>
<body>
    <!-- æ•°æ®åº“çŠ¶æ€æŒ‡ç¤ºå™¨ï¼Œä¾› app.js ä½¿ç”¨ -->
    <!-- <div style="margin: 10px 0;">
        <span id="db-indicator" class="db-indicator local">æœ¬åœ°</span>
        <span id="db-text">æœ¬åœ°å­˜å‚¨</span>
    </div> -->
    <div class="container">
        <header class="header">
            <h1>æ™ºèƒ½åŒ–æ–½å·¥ä»»åŠ¡ç®¡ç†ç³»ç»Ÿ</h1>
            <div class="header-controls">
                <div class="date-selector">
                    <button id="prev-day-btn" class="btn-secondary date-nav-btn">â—€ å‰ä¸€å¤©</button>
                    <input type="date" id="date-selector">
                    <button id="today-btn" class="btn-secondary">ä»Šå¤©</button>
                    <button id="next-day-btn" class="btn-secondary date-nav-btn">åä¸€å¤© â–¶</button>
                </div>
                <button id="print-today-btn" class="btn-print">æ‰“å°ä»Šæ—¥ä»»åŠ¡</button>
                <button onclick="window.open('admin.html', '_blank')" class="btn-secondary">åå°ç®¡ç†</button>
                <div style="display: flex; align-items: center; gap: 10px; border-left: 1px solid #ddd; padding-left: 10px; margin-left: 10px;">
                    <span id="user-info" style="font-size: 14px; color: #666;">ç”¨æˆ·: <strong id="username-display">-</strong></span>
                    <button onclick="handleLogout()" class="btn-secondary" style="padding: 6px 12px; font-size: 14px;">ç™»å‡º</button>
                </div>
            </div>
        </header>

        <main class="main-content">
            <!-- å·¦ä¾§ï¼šä»Šæ—¥ä»»åŠ¡ -->
            <section class="left-panel">
                <div class="panel-header">
                    <h2>ä»Šæ—¥ä»»åŠ¡</h2>
                    <span id="today-date" class="date-display"></span>
                    <p class="panel-description">åŒ…å«æ‰€æœ‰æœªå®Œæˆä»»åŠ¡ + ä»Šæ—¥å·²å®Œæˆä»»åŠ¡</p>
                </div>
                <div class="today-stats">
                    <span id="today-total">æ€»è®¡: 0</span>
                    <span id="today-pending">å¾…åŠ: 0</span>
                    <span id="today-in-progress">è¿›è¡Œä¸­: 0</span>
                    <span id="today-completed">å·²å®Œæˆ: 0</span>
                </div>
                <div id="today-tasks-container" class="tasks-container">
                    <p class="no-tasks">ä»Šæ—¥æš‚æ— ä»»åŠ¡</p>
                </div>
            </section>

            <!-- ä¸­é—´ï¼šä»»åŠ¡ç®¡ç† -->
            <section class="center-panel">
                <div class="task-form">
                    <h2>æ·»åŠ æ–°ä»»åŠ¡</h2>
                    <form id="add-task-form">
                        <div class="form-group">
                            <input type="text" id="task-title" placeholder="ä»»åŠ¡æ ‡é¢˜" required>
                        </div>
                        <div class="form-group">
                            <textarea id="task-description" placeholder="ä»»åŠ¡æè¿°ï¼ˆå¯é€‰ï¼‰" rows="2"></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <div class="category-select-container">
                                    <input type="hidden" id="task-category" value="">
                                    <button type="button" id="select-category-btn" class="select-btn category-btn">é€‰æ‹©ç±»åˆ«</button>
                                    <span id="selected-category-display" class="selected-category-display">æœªé€‰æ‹©</span>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="assignee-and-submit-container">
                                    <button type="button" id="select-assignees-btn" class="select-btn">é€‰æ‹©äººå‘˜</button>
                                    <button type="submit" class="submit-btn">æ·»åŠ ä»»åŠ¡</button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="task-controls">
                    <div class="search-bar">
                        <input type="text" id="search-input" placeholder="æœç´¢ä»»åŠ¡...">
                    </div>
                    <div class="filter-section">
                        <div class="filter-buttons">
                            <button class="filter-btn active" data-filter="all">å…¨éƒ¨</button>
                            <button class="filter-btn" data-filter="pending">å¾…åŠ</button>
                            <button class="filter-btn" data-filter="in-progress">è¿›è¡Œä¸­</button>
                            <button class="filter-btn" data-filter="completed">å·²å®Œæˆ</button>
                        </div>
                        <div class="category-filter">
                            <select id="category-filter">
                                <option value="all">æ‰€æœ‰ç±»åˆ«</option>
                            </select>
                        </div>
                        <div class="assignee-filter">
                            <select id="assignee-filter">
                                <option value="all">æ‰€æœ‰äººå‘˜</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="all-tasks">
                    <h3>æ‰€æœ‰ä»»åŠ¡</h3>
                    <div class="stats">
                        <span id="total-tasks">æ€»è®¡: 0</span>
                        <span id="pending-tasks">å¾…åŠ: 0</span>
                        <span id="in-progress-tasks">è¿›è¡Œä¸­: 0</span>
                        <span id="completed-tasks">å·²å®Œæˆ: 0</span>
                    </div>
                    <div id="all-tasks-container" class="tasks-container">
                        <p class="no-tasks">æš‚æ— ä»»åŠ¡</p>
                    </div>
                </div>
            </section>

            <!-- å³ä¾§ï¼šå‰ä¸€å¤©å®Œæˆæƒ…å†µ -->
            <section class="right-panel">
                <div class="panel-header">
                    <h2>å‰ä¸€å¤©ä»»åŠ¡å®Œæˆæƒ…å†µ</h2>
                    <span id="yesterday-date" class="date-display"></span>
                </div>
                <div class="completion-summary">
                    <div class="completion-rate">
                        <div class="rate-circle">
                            <span id="completion-percentage">0%</span>
                        </div>
                        <p>å®Œæˆç‡</p>
                    </div>
                    <div class="completion-details">
                        <div class="detail-item">
                            <span class="label">æ€»ä»»åŠ¡:</span>
                            <span id="yesterday-total-count">0</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">å·²å®Œæˆ:</span>
                            <span id="yesterday-completed-count">0</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">æœªå®Œæˆ:</span>
                            <span id="yesterday-incomplete-count">0</span>
                        </div>
                    </div>
                </div>
                <div class="yesterday-tasks">
                    <h4>å‰ä¸€å¤©çš„ä»»åŠ¡</h4>
                    <div id="yesterday-tasks-container" class="tasks-container">
                        <p class="no-tasks">å‰ä¸€å¤©æš‚æ— ä»»åŠ¡</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- ç¼–è¾‘ä»»åŠ¡æ¨¡æ€æ¡† -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>ç¼–è¾‘ä»»åŠ¡</h2>
            <form id="edit-task-form">
                <div class="form-group">
                    <input type="text" id="edit-task-title" placeholder="ä»»åŠ¡æ ‡é¢˜" required>
                </div>
                <div class="form-group">
                    <textarea id="edit-task-description" placeholder="ä»»åŠ¡æè¿°" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <select id="edit-task-status">
                        <option value="pending">å¾…åŠ</option>
                        <option value="in-progress">è¿›è¡Œä¸­</option>
                        <option value="completed">å·²å®Œæˆ</option>
                    </select>
                </div>
                <div class="form-group">
                    <div class="category-select-container">
                        <input type="hidden" id="edit-task-category" value="">
                        <button type="button" id="edit-select-category-btn" class="select-btn category-btn">é€‰æ‹©ç±»åˆ«</button>
                        <span id="edit-selected-category-display" class="selected-category-display">æœªé€‰æ‹©</span>
                    </div>
                </div>
                <div class="form-group">
                    <div class="assignee-input-container">
                        <!-- <label>æ–½å·¥äººå‘˜</label> -->
                        <div class="assignee-selector">
                            <!-- <div class="selected-assignees" id="edit-selected-assignees">
                                <span class="placeholder">ç‚¹å‡»é€‰æ‹©æ–½å·¥äººå‘˜...</span>
                            </div> -->
                            <button type="button" id="edit-select-assignees-btn" class="select-btn">é€‰æ‹©äººå‘˜</button>
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit">ä¿å­˜</button>
                    <button type="button" id="cancel-edit">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- å¤‡æ³¨ç®¡ç†æ¨¡æ€æ¡† -->
    <div id="notes-modal" class="modal">
        <div class="modal-content notes-modal-content">
            <span class="close" id="close-notes-modal">&times;</span>
            <h2 id="notes-modal-title">ä»»åŠ¡å¤‡æ³¨</h2>
            
            <div class="add-note-section">
                <h3>æ·»åŠ å¤‡æ³¨</h3>
                <form id="add-note-form">
                    <div class="form-group">
                        <textarea id="new-note-content" placeholder="è¾“å…¥å¤‡æ³¨å†…å®¹..." rows="3" required></textarea>
                    </div>
                    <button type="submit">æ·»åŠ å¤‡æ³¨</button>
                </form>
            </div>
            
            <div class="notes-list-section">
                <h3>æ‰€æœ‰å¤‡æ³¨</h3>
                <div id="notes-list">
                    <p class="no-notes">æš‚æ— å¤‡æ³¨</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘å¤‡æ³¨æ¨¡æ€æ¡† -->
    <div id="edit-note-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="close-edit-note-modal">&times;</span>
            <h2>ç¼–è¾‘å¤‡æ³¨</h2>
            <form id="edit-note-form">
                <div class="form-group">
                    <textarea id="edit-note-content" placeholder="ç¼–è¾‘å¤‡æ³¨å†…å®¹..." rows="3" required></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit">ä¿å­˜</button>
                    <button type="button" id="cancel-edit-note">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- äººå‘˜é€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="assignee-select-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="close-assignee-modal">&times;</span>
            <h2>é€‰æ‹©æ–½å·¥äººå‘˜</h2>
            <div class="assignee-modal-content">
                <div class="assignee-search">
                    <input type="text" id="assignee-modal-search" placeholder="æœç´¢äººå‘˜å§“åã€è§’è‰²æˆ–éƒ¨é—¨...">
                </div>
                <div class="assignee-list" id="assignee-modal-list">
                    <!-- äººå‘˜åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div class="modal-actions">
                    <button type="button" id="confirm-assignee-selection" class="btn-primary">ç¡®å®š</button>
                    <button type="button" id="cancel-assignee-selection" class="btn-secondary">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç±»åˆ«é€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="category-select-modal" class="modal">
        <div class="modal-content category-modal-layout">
            <span class="close" id="close-category-modal">&times;</span>
            <h2>é€‰æ‹©ä»»åŠ¡ç±»åˆ«</h2>
            <div class="category-modal-content">
                <div class="category-search">
                    <input type="text" id="category-modal-search" placeholder="æœç´¢ç±»åˆ«...">
                </div>
                <div class="category-layout">
                    <!-- å·¦ä¾§ï¼šä¸€çº§ç±»åˆ«èœå• -->
                    <div class="category-left-panel">
                        <div class="category-level-title">ç±»åˆ«</div>
                        <div class="category-first-level" id="category-first-level">
                            <!-- ä¸€çº§èœå•å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                    <!-- å³ä¾§ï¼šäºŒä¸‰çº§ç±»åˆ«æ ‘ -->
                    <div class="category-right-panel">
                        <div class="category-level-title">å­ç±»åˆ«</div>
                        <div class="category-tree" id="category-tree-container">
                            <!-- äºŒä¸‰çº§ç±»åˆ«æ ‘å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" id="confirm-category-selection" class="btn-primary">ç¡®å®š</button>
                    <button type="button" id="cancel-category-selection" class="btn-secondary">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ é™¤ä»»åŠ¡ç¡®è®¤å¼¹çª— -->
    <div id="delete-confirm-modal" class="delete-confirm-modal">
        <div class="delete-confirm-content">
            <div class="delete-confirm-header">
                <h3>åˆ é™¤ä»»åŠ¡</h3>
            </div>
            <div class="delete-confirm-body">
                <div class="delete-confirm-icon">ğŸ—‘ï¸</div>
                <div class="delete-confirm-message">ç¡®å®šè¦åˆ é™¤æ­¤ä»»åŠ¡å—ï¼Ÿ</div>
                <div id="delete-confirm-task" class="delete-confirm-task"></div>
                <div class="delete-confirm-warning">æ­¤æ“ä½œæ— æ³•æ’¤é”€</div>
            </div>
            <div class="delete-confirm-actions">
                <button type="button" id="confirm-delete-btn" class="delete-confirm-btn btn-confirm-delete">åˆ é™¤</button>
                <button type="button" id="cancel-delete-btn" class="delete-confirm-btn btn-cancel-delete">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡ç®¡ç†æ¨¡æ€æ¡† -->
    <div id="images-modal" class="modal">
        <div class="modal-content images-modal-content">
            <span class="close" id="close-images-modal">&times;</span>
            <h2 id="images-modal-title">ä»»åŠ¡å›¾ç‰‡</h2>

            <div class="upload-section">
                <h3>ä¸Šä¼ å›¾ç‰‡</h3>
                <div class="upload-area">
                    <input type="file" id="image-upload" accept="image/*" multiple style="display: none;">
                    <button type="button" id="upload-btn" class="btn-upload">
                        <span>ğŸ“·</span> é€‰æ‹©å›¾ç‰‡
                    </button>
                    <div class="upload-info">æ”¯æŒ JPG, PNG, GIF æ ¼å¼ï¼Œå•ä¸ªæ–‡ä»¶æœ€å¤§ 5MB</div>
                </div>
            </div>

            <div class="images-gallery-section">
                <h3>å·²ä¸Šä¼ çš„å›¾ç‰‡</h3>
                <div id="images-gallery" class="images-gallery">
                    <div class="no-images">æš‚æ— å›¾ç‰‡</div>
                </div>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† -->
    <div id="image-preview-modal" class="modal">
        <div class="modal-content image-preview-content">
            <span class="close" id="close-image-preview">&times;</span>
            <div class="image-preview-container">
                <div class="image-navigation">
                    <button type="button" id="prev-image-btn" class="nav-btn prev-btn">â®</button>
                    <div class="image-wrapper">
                        <img id="preview-image" src="" alt="å›¾ç‰‡é¢„è§ˆ">
                        <div class="image-info">
                            <span id="image-counter">1 / 1</span>
                            <span id="image-name">å›¾ç‰‡åç§°</span>
                        </div>
                    </div>
                    <button type="button" id="next-image-btn" class="nav-btn next-btn">â¯</button>
                </div>
                <div class="image-preview-actions">
                    <button type="button" id="delete-image-btn" class="btn-delete">åˆ é™¤å›¾ç‰‡</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ä»»åŠ¡å®Œæˆç¡®è®¤å¼¹çª— -->
    <div id="complete-confirm-modal" class="complete-confirm-modal">
        <div class="complete-confirm-content">
            <div class="complete-confirm-header">
                <h3>ç¡®è®¤å®Œæˆä»»åŠ¡</h3>
            </div>
            <div class="complete-confirm-body">
                <div class="complete-confirm-message">ç¡®å®šè¦å°†æ­¤ä»»åŠ¡æ ‡è®°ä¸ºå·²å®Œæˆå—ï¼Ÿ</div>
                <div id="complete-confirm-task" class="complete-confirm-task"></div>
            </div>
            <div class="complete-confirm-actions">
                <button type="button" id="confirm-complete-btn" class="complete-confirm-btn btn-confirm-complete">ç¡®è®¤å®Œæˆ</button>
                <button type="button" id="cancel-complete-btn" class="complete-confirm-btn btn-cancel-complete">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- ä»»åŠ¡å®ŒæˆæˆåŠŸå¼¹çª— -->
    <div id="complete-success-modal" class="complete-success-modal">
        <div class="complete-success-content">
            <div class="complete-success-header">
                <h3>ä»»åŠ¡å·²å®Œæˆ</h3>
            </div>
            <div class="complete-success-body">
                <div id="complete-success-message" class="complete-success-message-text">ä»»åŠ¡å·²æˆåŠŸæ ‡è®°ä¸ºå®Œæˆï¼</div>
            </div>
            <div class="complete-success-actions">
                <button type="button" id="complete-success-ok-btn" class="complete-success-btn btn-complete-success-ok">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <!-- æ‰“å°æ ·å¼ -->
    <style media="print">
        .container { max-width: none; padding: 20px; }
        .header, .center-panel, .right-panel { display: none !important; }
        .left-panel { width: 100% !important; max-width: none !important; }
        .main-content { grid-template-columns: 1fr !important; }
        .panel-header h2 { font-size: 24px; margin-bottom: 20px; }
        .task-item { page-break-inside: avoid; margin-bottom: 15px; border: 1px solid #ccc; }
        .task-actions { display: none !important; }
        @page { margin: 1cm; }
    </style>

    <script>
        // åŠ è½½ç”¨æˆ·ä¿¡æ¯
        async function loadUserInfo() {
            try {
                const response = await fetch('api/index.php/auth?action=check', {
                    method: 'GET',
                    credentials: 'include'
                });
                const data = await response.json();
                if (data.success && data.data && data.data.username) {
                    document.getElementById('username-display').textContent = data.data.username;
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // å¤„ç†ç™»å‡º
        async function handleLogout() {
            if (!confirm('ç¡®å®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch('api/index.php/auth?action=logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                const data = await response.json();
                if (data.success) {
                    // æ¸…ç©ºä¿å­˜çš„å‡­è¯
                    localStorage.removeItem('todolist_credentials');
                    // è·³è½¬åˆ°ç™»å½•é¡µé¢
                    window.location.href = 'login.html';
                } else {
                    alert('ç™»å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            } catch (error) {
                console.error('ç™»å‡ºé”™è¯¯:', error);
                alert('ç™»å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è·å–ç”¨æˆ·ä¿¡æ¯
        document.addEventListener('DOMContentLoaded', loadUserInfo);
    </script>

    <script type="module" src="src/app.js"></script>
</body>
</html>