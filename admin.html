<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob:; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <title>æ–½å·¥ä»»åŠ¡ç®¡ç†ç³»ç»Ÿ - åå°ç®¡ç†</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/admin.css">
    <link rel="stylesheet" href="styles/database-status.css">
    <script>
        // æƒé™æ£€æŸ¥ï¼šç¡®ä¿ç”¨æˆ·å·²ç™»å½•
        (function checkAuth() {
            // æ ‡è®°ï¼šé˜²æ­¢é‡å¤æ£€æŸ¥
            if (window.__authChecked) return;
            window.__authChecked = true;

            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            fetch('api/index.php/auth?action=check', {
                method: 'GET',
                credentials: 'include'
            })
            .then(res => res.json())
            .then(data => {
                if (!data.success) {
                    // æœªç™»å½•ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µé¢
                    window.location.href = 'login.html';
                } else {
                    // å·²ç™»å½•ï¼Œæ˜¾ç¤ºç”¨æˆ·åï¼ˆå¯é€‰ï¼‰
                    console.log('ç”¨æˆ·å·²ç™»å½•:', data.data.username);
                }
            })
            .catch(error => {
                console.error('æƒé™æ£€æŸ¥å¤±è´¥:', error);
                // é”™è¯¯æ—¶ä¹Ÿé‡å®šå‘åˆ°ç™»å½•é¡µé¢
                window.location.href = 'login.html';
            });
        })();
    </script>
</head>
<body>
    <div class="container">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <header class="admin-header">
            <h1>æ–½å·¥ä»»åŠ¡ - åå°ç®¡ç†</h1>
            <div class="admin-nav">
                <button id="personnel-tab" class="nav-btn active">äººå‘˜ç®¡ç†</button>
                <button id="category-tab" class="nav-btn">ç±»åˆ«ç®¡ç†</button>
                <button id="tasks-tab" class="nav-btn">ä»»åŠ¡ç±»åˆ«è¯¦æƒ…</button>
                <button id="stats-tab" class="nav-btn">ç»Ÿè®¡æŠ¥è¡¨</button>
                <button id="database-tab" class="nav-btn">æ•°æ®åº“ç®¡ç†</button>
                <button id="back-to-main" class="nav-btn secondary">è¿”å›ä¸»é¡µ</button>
                <div style="display: flex; align-items: center; gap: 10px; margin-left: auto; border-left: 1px solid #ddd; padding-left: 10px;">
                    <span style="font-size: 14px; color: #666;">ç”¨æˆ·: <strong id="admin-username-display">-</strong></span>
                    <button onclick="openAdminChangePasswordModal()" class="nav-btn secondary" style="padding: 6px 12px; font-size: 14px; margin: 0;">ä¿®æ”¹è´¦å·</button>
                    <button onclick="handleAdminLogout()" class="nav-btn secondary" style="padding: 6px 12px; font-size: 14px; margin: 0;">ç™»å‡º</button>
                </div>
            </div>
        </header>

        <!-- äººå‘˜ç®¡ç†é¡µé¢ -->
        <main id="personnel-section" class="admin-section active">
            <div class="section-header">
                <h2>æ–½å·¥äººå‘˜ç®¡ç†</h2>
                <div class="personnel-header-buttons">
                    <button id="add-personnel-btn" class="btn-primary">æ·»åŠ äººå‘˜</button>
                    <button id="working-hours-btn" class="btn-secondary">ä¸Šä¸‹ç­æ—¶é—´è®¾ç½®</button>
                </div>
            </div>

            <!-- äººå‘˜æœç´¢å’Œç­›é€‰ -->
            <div class="admin-controls">
                <div class="search-section">
                    <input type="text" id="personnel-search" placeholder="æœç´¢äººå‘˜å§“åã€è§’è‰²æˆ–éƒ¨é—¨...">
                </div>
                <div class="filter-section">
                    <select id="role-filter">
                        <option value="all">æ‰€æœ‰è§’è‰²</option>
                    </select>
                    <select id="department-filter">
                        <option value="all">æ‰€æœ‰éƒ¨é—¨</option>
                    </select>
                </div>
            </div>

            <!-- äººå‘˜åˆ—è¡¨ -->
            <div class="personnel-grid">
                <div class="grid-header">
                    <div>å§“å</div>
                    <div>è§’è‰²</div>
                    <div>éƒ¨é—¨</div>
                    <div>ç”µè¯</div>
                    <div>åˆ›å»ºæ—¶é—´</div>
                    <div>æ“ä½œ</div>
                </div>
                <div id="personnel-list" class="grid-content">
                    <div class="no-data">æš‚æ— äººå‘˜æ•°æ®</div>
                </div>
            </div>
        </main>

        <!-- ç±»åˆ«ç®¡ç†é¡µé¢ -->
        <main id="category-section" class="admin-section">
            <div class="section-header">
                <h2>ä»»åŠ¡ç±»åˆ«ç®¡ç†</h2>
                <div class="category-controls">
                    <button id="add-category-btn" class="btn-primary">æ·»åŠ æ ¹ç±»åˆ«</button>
                    <button id="expand-all-btn" class="btn-secondary">å±•å¼€å…¨éƒ¨</button>
                    <button id="collapse-all-btn" class="btn-secondary">æ”¶èµ·å…¨éƒ¨</button>
                </div>
            </div>

            <!-- æœç´¢åŠŸèƒ½ -->
            <div class="admin-controls">
                <div class="search-section">
                    <input type="text" id="category-search" placeholder="æœç´¢ç±»åˆ«åç§°æˆ–è·¯å¾„...">
                    <button id="clear-search-btn" class="btn-secondary">æ¸…é™¤</button>
                </div>
            </div>

            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="category-stats-bar">
                <div class="stat-item">
                    <span class="stat-icon">ğŸ“Š</span>
                    <span class="stat-label">ç±»åˆ«æ€»æ•°</span>
                    <span id="category-count" class="stat-value">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-icon">ğŸ“</span>
                    <span class="stat-label">æœ€å¤§å±‚çº§</span>
                    <span id="level-info" class="stat-value">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-icon">ğŸŒ¿</span>
                    <span class="stat-label">å¶å­èŠ‚ç‚¹</span>
                    <span id="leaf-count" class="stat-value">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-icon">ğŸŒ³</span>
                    <span class="stat-label">æ ¹èŠ‚ç‚¹</span>
                    <span id="root-count" class="stat-value">0</span>
                </div>
            </div>

            <!-- ç±»åˆ«æ ‘å½¢ç»“æ„ -->
            <div class="category-tree-container">
                <div id="category-tree" class="category-tree">
                    <div class="no-categories">æš‚æ— ç±»åˆ«æ•°æ®</div>
                </div>
            </div>

            <!-- ç±»åˆ«è·¯å¾„å¯¼èˆª -->
            <div id="category-breadcrumb" class="category-breadcrumb" style="display: none;">
                <span class="breadcrumb-label">å½“å‰ä½ç½®ï¼š</span>
                <div class="breadcrumb-path"></div>
            </div>
        </main>

        <!-- ä»»åŠ¡ç±»åˆ«è¯¦æƒ…é¡µé¢ -->
        <main id="tasks-section" class="admin-section">
            <div class="section-header">
                <h2>ä»»åŠ¡ç±»åˆ«è¯¦æƒ…</h2>
                <div class="task-controls">
                    <select id="category-filter-tasks">
                        <option value="all">æ‰€æœ‰ç±»åˆ«</option>
                    </select>
                    <select id="status-filter-tasks">
                        <option value="all">æ‰€æœ‰çŠ¶æ€</option>
                        <option value="pending">å¾…åŠ</option>
                        <option value="in-progress">è¿›è¡Œä¸­</option>
                        <option value="completed">å·²å®Œæˆ</option>
                    </select>
                    <button id="refresh-tasks-btn" class="btn-secondary">åˆ·æ–°</button>
                </div>
            </div>

            <!-- ä»»åŠ¡ç»Ÿè®¡å¡ç‰‡ -->
            <div class="task-stats-cards">
                <div class="stat-card">
                    <h3>æ€»ä»»åŠ¡æ•°</h3>
                    <div class="stat-number" id="total-tasks-count">0</div>
                </div>
                <div class="stat-card">
                    <h3>å·²å®Œæˆ</h3>
                    <div class="stat-number completed" id="completed-tasks-count">0</div>
                </div>
                <div class="stat-card">
                    <h3>è¿›è¡Œä¸­</h3>
                    <div class="stat-number in-progress" id="inprogress-tasks-count">0</div>
                </div>
                <div class="stat-card">
                    <h3>å¾…åŠ</h3>
                    <div class="stat-number pending" id="pending-tasks-count">0</div>
                </div>
                <div class="stat-card">
                    <h3>å¹³å‡å®Œæˆå¤©æ•°</h3>
                    <div class="stat-number" id="avg-completion-days">0</div>
                </div>
            </div>

            <!-- ä»»åŠ¡åˆ—è¡¨ -->
            <div class="tasks-grid">
                <div class="grid-header">
                    <div>æ ‡é¢˜</div>
                    <div>ç±»åˆ«</div>
                    <div>çŠ¶æ€</div>
                    <div>åˆ†é…äººå‘˜</div>
                    <div>åˆ›å»ºæ—¶é—´</div>
                    <div>å®Œæˆæ—¶é—´</div>
                    <div>ç”¨æ—¶å¤©æ•°</div>
                    <div>æ“ä½œ</div>
                </div>
                <div id="tasks-list" class="grid-content">
                    <div class="no-data">æš‚æ— ä»»åŠ¡æ•°æ®</div>
                </div>
            </div>
        </main>

        <!-- ç»Ÿè®¡æŠ¥è¡¨é¡µé¢ -->
        <main id="stats-section" class="admin-section">
            <div class="section-header">
                <h2>ç»Ÿè®¡æŠ¥è¡¨</h2>
                <div class="stats-controls">
                    <input type="date" id="stats-start-date">
                    <input type="date" id="stats-end-date">
                    <button id="generate-stats" class="btn-secondary">ç”ŸæˆæŠ¥è¡¨</button>
                    <button id="export-word-btn" class="btn-primary">å¯¼å‡ºWordæŠ¥è¡¨</button>
                </div>
            </div>

            <!-- æ€»ä½“ç»Ÿè®¡å¡ç‰‡ -->
            <div class="stats-grid">
                <div class="stats-card">
                    <h3>æ€»ä½“ç»Ÿè®¡</h3>
                    <div class="stats-content">
                        <div class="stat-item">
                            <span class="stat-label">æ€»ä»»åŠ¡æ•°:</span>
                            <span id="total-tasks-stat" class="stat-value">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">å·²å®Œæˆ:</span>
                            <span id="completed-tasks-stat" class="stat-value">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">è¿›è¡Œä¸­:</span>
                            <span id="inprogress-tasks-stat" class="stat-value">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">å¾…åŠ:</span>
                            <span id="pending-tasks-stat" class="stat-value">0</span>
                        </div>
                    </div>
                </div>

                <div class="stats-card">
                    <h3>äººå‘˜å·¥ä½œé‡ç»Ÿè®¡</h3>
                    <div id="personnel-workload" class="stats-content">
                        <div class="no-data">è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´ç”ŸæˆæŠ¥è¡¨</div>
                    </div>
                </div>

                <div class="stats-card">
                    <h3>ç±»åˆ«åˆ†å¸ƒ</h3>
                    <div id="category-distribution" class="stats-content">
                        <div class="no-data">è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´ç”ŸæˆæŠ¥è¡¨</div>
                    </div>
                </div>
            </div>

            <!-- ç±»åˆ«å®Œæˆç‡ç»Ÿè®¡ - å·¦å³2åˆ—å¸ƒå±€ -->
            <div class="section-header">
                <h2>ç±»åˆ«ä»»åŠ¡å®Œæˆç‡ç»Ÿè®¡</h2>
            </div>
            <div class="category-stats-layout">
                <!-- å·¦ä¾§ï¼šä¸€çº§ç±»åˆ«èœå• -->
                <div class="category-stats-left">
                    <h3>é€‰æ‹©ç±»åˆ«</h3>
                    <div id="category-stats-menu" class="category-stats-menu">
                        <div class="no-data">æš‚æ— ç±»åˆ«æ•°æ®</div>
                    </div>
                </div>
                <!-- å³ä¾§ï¼šåœ†å½¢ç™¾åˆ†æ¯”ç»Ÿè®¡ -->
                <div class="category-stats-right">
                    <div id="category-stats-display" class="category-stats-display">
                        <div class="no-data">è¯·é€‰æ‹©ç±»åˆ«æŸ¥çœ‹è¯¦æƒ…</div>
                    </div>
                </div>
            </div>
        </main>

        <!-- æ•°æ®åº“ç®¡ç†é¡µé¢ -->
        <main id="database-section" class="admin-section">
            <div class="section-header">
                <h2>æ•°æ®åº“ç®¡ç†</h2>
            </div>

            <div class="database-controls">
                <div class="control-group">
                    <h3>æ•°æ®å¯¼å…¥å¯¼å‡º</h3>
                    <div class="button-group">
                        <button id="export-data-btn" class="btn-secondary">å¯¼å‡ºæ•°æ®</button>
                        <button id="import-data-btn" class="btn-secondary">å¯¼å…¥æ•°æ®</button>
                        <button id="import-text-btn" class="btn-secondary">æ‰‹åŠ¨å¯¼å…¥</button>
                        <input type="file" id="import-file-input" accept=".json" style="display: none;">
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘äººå‘˜æ¨¡æ€æ¡† -->
    <div id="personnel-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="close-personnel-modal">&times;</span>
            <h2 id="personnel-modal-title">æ·»åŠ äººå‘˜</h2>
            <form id="personnel-form">
                <div class="form-group">
                    <label>å§“å <span class="required">*</span></label>
                    <input type="text" id="personnel-name" placeholder="è¯·è¾“å…¥å§“å" required>
                </div>
                <div class="form-group">
                    <label>è§’è‰²</label>
                    <input type="text" id="personnel-role" placeholder="å¦‚ï¼šä¸»ç®¡ã€ç”µå·¥ã€æœ¨å·¥ç­‰" list="role-suggestions">
                    <datalist id="role-suggestions">
                        <option value="ä¸»ç®¡">
                        <option value="ç”µå·¥">
                        <option value="æœ¨å·¥">
                        <option value="æ°´å·¥">
                        <option value="ç“¦å·¥">
                        <option value="æ²¹å·¥">
                        <option value="é’¢ç­‹å·¥">
                        <option value="æ··å‡åœŸå·¥">
                    </datalist>
                </div>
                <div class="form-group">
                    <label>éƒ¨é—¨</label>
                    <input type="text" id="personnel-department" placeholder="å¦‚ï¼šAç»„ã€Bç»„ç­‰" list="department-suggestions">
                    <datalist id="department-suggestions">
                        <option value="Aç»„">
                        <option value="Bç»„">
                        <option value="Cç»„">
                        <option value="è´¨æ£€ç»„">
                        <option value="å®‰å…¨ç»„">
                    </datalist>
                </div>
                <div class="form-group">
                    <label>è”ç³»ç”µè¯</label>
                    <input type="tel" id="personnel-phone" placeholder="è¯·è¾“å…¥ç”µè¯å·ç ">
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-primary">ä¿å­˜</button>
                    <button type="button" id="cancel-personnel" class="btn-secondary">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘ç±»åˆ«æ¨¡æ€æ¡† -->
    <div id="category-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="close-category-modal">&times;</span>
            <h2 id="category-modal-title">æ·»åŠ ç±»åˆ«</h2>
            <form id="category-form">
                <div class="form-group">
                    <label>ç±»åˆ«åç§° <span class="required">*</span></label>
                    <input type="text" id="category-name" placeholder="è¯·è¾“å…¥ç±»åˆ«åç§°" required>
                </div>
                <div class="form-group">
                    <label>çˆ¶ç±»åˆ«</label>
                    <select id="category-parent">
                        <option value="">é€‰æ‹©çˆ¶ç±»åˆ«ï¼ˆç•™ç©ºä¸ºæ ¹ç±»åˆ«ï¼‰</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>é¢„è§ˆè·¯å¾„</label>
                    <div id="category-path-preview" class="path-preview">æœªé€‰æ‹©çˆ¶ç±»åˆ«</div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-primary">ä¿å­˜</button>
                    <button type="button" id="cancel-category" class="btn-secondary">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ç§»åŠ¨ç±»åˆ«æ¨¡æ€æ¡† -->
    <div id="move-category-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="close-move-modal">&times;</span>
            <h2>ç§»åŠ¨ç±»åˆ«</h2>
            <form id="move-category-form">
                <div class="form-group">
                    <label>å½“å‰ç±»åˆ«</label>
                    <div id="current-category-info" class="category-info"></div>
                </div>
                <div class="form-group">
                    <label>ç§»åŠ¨åˆ°</label>
                    <select id="move-target-parent" required>
                        <option value="">é€‰æ‹©ç›®æ ‡ä½ç½®</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æ–°è·¯å¾„é¢„è§ˆ</label>
                    <div id="new-path-preview" class="path-preview">è¯·é€‰æ‹©ç›®æ ‡ä½ç½®</div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-primary">ç§»åŠ¨</button>
                    <button type="button" id="cancel-move" class="btn-secondary">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ç±»åˆ«åˆ é™¤ç¡®è®¤å¼¹çª— -->
    <div id="delete-confirm-modal" class="delete-confirm-modal">
        <div class="delete-confirm-content">
            <div class="delete-confirm-header">
                <h3>ç¡®è®¤åˆ é™¤</h3>
            </div>
            <div class="delete-confirm-body">
                <div class="delete-confirm-message">ç¡®å®šè¦åˆ é™¤ç±»åˆ«</div>
                <div id="delete-confirm-category" class="delete-confirm-category"></div>
                <div class="delete-confirm-warning">åˆ é™¤åå°†æ— æ³•æ¢å¤ï¼Œè¯·è°¨æ…æ“ä½œ</div>
            </div>
            <div class="delete-confirm-actions">
                <button type="button" id="confirm-delete-btn" class="delete-confirm-btn btn-confirm-delete">ç¡®è®¤åˆ é™¤</button>
                <button type="button" id="cancel-delete-btn" class="delete-confirm-btn btn-cancel-delete">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- æˆåŠŸæç¤ºå¼¹çª— -->
    <div id="success-modal" class="success-modal">
        <div class="success-content">
            <div class="success-header">
                <h3>æ“ä½œæˆåŠŸ</h3>
            </div>
            <div class="success-body">
                <div id="success-message" class="success-message-text">æ“ä½œå·²æˆåŠŸå®Œæˆ</div>
            </div>
            <div class="success-actions">
                <button type="button" id="success-ok-btn" class="success-btn btn-success-ok">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <!-- è­¦å‘Šæç¤ºå¼¹çª— -->
    <div id="warning-modal" class="warning-modal">
        <div class="warning-content">
            <div class="warning-header">
                <h3>æ“ä½œæç¤º</h3>
            </div>
            <div class="warning-body">
                <div id="warning-message" class="warning-message-text">è¯·æ³¨æ„ç›¸å…³æ“ä½œé™åˆ¶</div>
            </div>
            <div class="warning-actions">
                <button type="button" id="warning-ok-btn" class="warning-btn btn-warning-ok">çŸ¥é“äº†</button>
            </div>
        </div>
    </div>

    <!-- ä¸Šä¸‹ç­æ—¶é—´è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="working-hours-modal" class="modal">
        <div class="modal-content working-hours-modal-content">
            <span class="close" id="close-working-hours-modal">&times;</span>
            <h2>ä¸Šä¸‹ç­æ—¶é—´è®¾ç½®</h2>

            <!-- å…¨å±€æ—¶é—´è®¾ç½® -->
            <div class="working-hours-section">
                <h3>å…¨å±€é»˜è®¤æ—¶é—´</h3>
                <div class="form-group">
                    <label>é»˜è®¤ä¸Šç­æ—¶é—´</label>
                    <input type="time" id="global-start-time" value="08:00">
                </div>
                <div class="form-group">
                    <label>é»˜è®¤ä¸‹ç­æ—¶é—´</label>
                    <input type="time" id="global-end-time" value="17:00">
                </div>
                <button id="save-global-hours-btn" class="btn-primary">ä¿å­˜å…¨å±€æ—¶é—´</button>
            </div>

            <!-- ä¸ªäººæ—¶é—´è®¾ç½® -->
            <div class="working-hours-section">
                <h3>ä¸ªäººæ—¶é—´è®¾ç½®</h3>
                <div class="personnel-hours-controls">
                    <div class="search-box">
                        <input type="text" id="hours-personnel-search" placeholder="æœç´¢äººå‘˜...">
                    </div>
                </div>
                <div class="personnel-hours-list">
                    <div id="personnel-hours-content" class="hours-grid">
                        <div class="no-data">æš‚æ— äººå‘˜æ•°æ®</div>
                    </div>
                </div>
            </div>

            <div class="form-actions">
                <button type="button" id="close-working-hours-btn" class="btn-secondary">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘ä¸ªäººæ—¶é—´æ¨¡æ€æ¡† -->
    <div id="edit-person-hours-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="close-edit-person-hours">&times;</span>
            <h2 id="edit-person-hours-title">ç¼–è¾‘æ—¶é—´è®¾ç½®</h2>
            <form id="edit-person-hours-form">
                <div class="form-group">
                    <label>äººå‘˜å§“å</label>
                    <div id="edit-person-name" class="person-name-display"></div>
                </div>
                <div class="form-group">
                    <label>ä¸Šç­æ—¶é—´</label>
                    <input type="time" id="edit-start-time" required>
                </div>
                <div class="form-group">
                    <label>ä¸‹ç­æ—¶é—´</label>
                    <input type="time" id="edit-end-time" required>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="use-global-hours-checkbox">
                        ä½¿ç”¨å…¨å±€é»˜è®¤æ—¶é—´
                    </label>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn-primary">ä¿å­˜</button>
                    <button type="button" id="cancel-edit-person-hours" class="btn-secondary">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ä¿®æ”¹è´¦å·æ¨¡æ€æ¡†ï¼ˆåŒ…å«ç”¨æˆ·åå’Œå¯†ç ï¼‰ -->
    <div id="admin-change-password-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="close-admin-change-password-modal">&times;</span>
            <h2>ä¿®æ”¹è´¦å·ä¿¡æ¯</h2>
            <form id="admin-change-password-form">
                <div class="form-group">
                    <label for="admin-current-password">å½“å‰å¯†ç :</label>
                    <input type="password" id="admin-current-password" placeholder="è¯·è¾“å…¥å½“å‰å¯†ç ï¼ˆå¿…å¡«ï¼‰" required>
                </div>

                <div class="form-group">
                    <label for="admin-new-username">æ–°ç”¨æˆ·å (å¯é€‰):</label>
                    <input type="text" id="admin-new-username" placeholder="3-20ä¸ªå­—ç¬¦ï¼Œä»…åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿">
                </div>

                <div class="form-group">
                    <label for="admin-new-password">æ–°å¯†ç  (å¯é€‰):</label>
                    <input type="password" id="admin-new-password" placeholder="è‡³å°‘6ä¸ªå­—ç¬¦ï¼Œç•™ç©ºè¡¨ç¤ºä¸ä¿®æ”¹">
                </div>

                <div class="form-group">
                    <label for="admin-confirm-password">ç¡®è®¤æ–°å¯†ç :</label>
                    <input type="password" id="admin-confirm-password" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç ">
                </div>

                <div id="admin-change-password-message" style="margin: 15px 0; padding: 10px; border-radius: 4px; display: none;"></div>
                <div class="form-actions">
                    <button type="submit" class="btn-primary">ç¡®è®¤ä¿®æ”¹</button>
                    <button type="button" id="cancel-admin-change-password" class="btn-secondary">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- æ·»åŠ JSZipåº“ç”¨äºç”Ÿæˆæ ‡å‡†Wordæ–‡æ¡£ -->
    <script src="src/jszip.min.js"></script>
    <script>
        // ç­‰å¾…JSZipåº“åŠ è½½å®Œæˆ
        window.addEventListener('load', function() {
            console.log('JSZip available:', typeof window.JSZip !== 'undefined');
            if (typeof window.JSZip === 'undefined') {
                console.warn('JSZip library failed to load, Word export will use fallback format');
            }
        });
    </script>

    <script>
        // åŠ è½½ç”¨æˆ·ä¿¡æ¯
        async function loadAdminUserInfo() {
            try {
                const response = await fetch('api/index.php/auth?action=check', {
                    method: 'GET',
                    credentials: 'include'
                });
                const data = await response.json();
                if (data.success && data.data && data.data.username) {
                    document.getElementById('admin-username-display').textContent = data.data.username;
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // å¤„ç†ç™»å‡º
        async function handleAdminLogout() {
            if (!confirm('ç¡®å®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch('api/index.php/auth?action=logout', {
                    method: 'POST',
                    credentials: 'include'
                });
                const data = await response.json();
                if (data.success) {
                    // æ¸…ç©ºä¿å­˜çš„å‡­è¯
                    localStorage.removeItem('todolist_credentials');
                    // è·³è½¬åˆ°ç™»å½•é¡µé¢
                    window.location.href = 'login.html';
                } else {
                    alert('ç™»å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            } catch (error) {
                console.error('ç™»å‡ºé”™è¯¯:', error);
                alert('ç™»å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è·å–ç”¨æˆ·ä¿¡æ¯
        document.addEventListener('DOMContentLoaded', loadAdminUserInfo);

        // æ‰“å¼€ä¿®æ”¹è´¦å·æ¨¡æ€æ¡†
        function openAdminChangePasswordModal() {
            document.getElementById('admin-change-password-modal').style.display = 'block';
            document.getElementById('admin-change-password-form').reset();
            document.getElementById('admin-change-password-message').style.display = 'none';
        }

        // å…³é—­ä¿®æ”¹è´¦å·æ¨¡æ€æ¡†
        function closeAdminChangePasswordModal() {
            document.getElementById('admin-change-password-modal').style.display = 'none';
            document.getElementById('admin-change-password-form').reset();
            document.getElementById('admin-change-password-message').style.display = 'none';
        }

        // ä¿®æ”¹è´¦å·è¡¨å•æäº¤ï¼ˆæ”¯æŒä¿®æ”¹ç”¨æˆ·åå’Œ/æˆ–å¯†ç ï¼‰
        document.getElementById('admin-change-password-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const currentPassword = document.getElementById('admin-current-password').value;
            const newUsername = document.getElementById('admin-new-username').value.trim();
            const newPassword = document.getElementById('admin-new-password').value;
            const confirmPassword = document.getElementById('admin-confirm-password').value;
            const messageEl = document.getElementById('admin-change-password-message');

            // è‡³å°‘éœ€è¦ä¿®æ”¹ä¸€é¡¹
            if (!newUsername && !newPassword) {
                messageEl.textContent = 'è¯·è‡³å°‘ä¿®æ”¹ç”¨æˆ·åæˆ–å¯†ç ä¸­çš„ä¸€é¡¹';
                messageEl.className = 'error-message';
                messageEl.style.display = 'block';
                return;
            }

            // å¦‚æœä¿®æ”¹ç”¨æˆ·åï¼Œæ£€æŸ¥æ ¼å¼
            if (newUsername) {
                if (newUsername.length < 3 || newUsername.length > 20) {
                    messageEl.textContent = 'ç”¨æˆ·åé•¿åº¦éœ€è¦åœ¨ 3-20 ä¸ªå­—ç¬¦ä¹‹é—´';
                    messageEl.className = 'error-message';
                    messageEl.style.display = 'block';
                    return;
                }
                if (!/^[a-zA-Z0-9_]+$/.test(newUsername)) {
                    messageEl.textContent = 'ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿';
                    messageEl.className = 'error-message';
                    messageEl.style.display = 'block';
                    return;
                }
            }

            // å¦‚æœä¿®æ”¹å¯†ç ï¼Œæ£€æŸ¥æ ¼å¼
            if (newPassword) {
                if (newPassword.length < 6) {
                    messageEl.textContent = 'æ–°å¯†ç è‡³å°‘éœ€è¦ 6 ä¸ªå­—ç¬¦';
                    messageEl.className = 'error-message';
                    messageEl.style.display = 'block';
                    return;
                }

                if (newPassword !== confirmPassword) {
                    messageEl.textContent = 'ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´';
                    messageEl.className = 'error-message';
                    messageEl.style.display = 'block';
                    return;
                }
            }

            try {
                const response = await fetch('api/index.php/auth?action=change-account', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        currentPassword: currentPassword,
                        newUsername: newUsername,
                        newPassword: newPassword,
                        confirmPassword: confirmPassword
                    })
                });

                const data = await response.json();

                if (data.success) {
                    messageEl.textContent = 'è´¦å·ä¿¡æ¯ä¿®æ”¹æˆåŠŸï¼';
                    messageEl.className = 'success-message';
                    messageEl.style.display = 'block';
                    document.getElementById('admin-change-password-form').reset();

                    // å¦‚æœä¿®æ”¹äº†ç”¨æˆ·åï¼Œæ›´æ–°é¡µé¢æ˜¾ç¤º
                    if (data.data && data.data.username) {
                        document.getElementById('admin-username-display').textContent = data.data.username;
                    }

                    // 2ç§’åå…³é—­æ¨¡æ€æ¡†
                    setTimeout(() => {
                        closeAdminChangePasswordModal();
                    }, 2000);
                } else {
                    messageEl.textContent = data.error || data.message || 'ä¿®æ”¹å¤±è´¥';
                    messageEl.className = 'error-message';
                    messageEl.style.display = 'block';
                }
            } catch (error) {
                console.error('ä¿®æ”¹è´¦å·é”™è¯¯:', error);
                messageEl.textContent = 'ä¿®æ”¹å¤±è´¥ï¼Œè¯·é‡è¯•';
                messageEl.className = 'error-message';
                messageEl.style.display = 'block';
            }
        });

        // å…³é—­æŒ‰é’®
        document.getElementById('cancel-admin-change-password').addEventListener('click', closeAdminChangePasswordModal);
        document.getElementById('close-admin-change-password-modal').addEventListener('click', closeAdminChangePasswordModal);

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('admin-change-password-modal');
            if (event.target === modal) {
                closeAdminChangePasswordModal();
            }
        });

        // æ·»åŠ æ ·å¼ç±»
        const style = document.createElement('style');
        style.textContent = `
            .error-message {
                background-color: #ffebee;
                color: #c62828;
                border: 1px solid #ef5350;
            }
            .success-message {
                background-color: #e8f5e9;
                color: #2e7d32;
                border: 1px solid #66bb6a;
            }
        `;
        document.head.appendChild(style);
    </script>

    <!-- åŠ è½½adminç®¡ç†ç•Œé¢ -->
    <script type="module" src="src/admin.js"></script>
</body>
</html>